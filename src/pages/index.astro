---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Hero from "../components/Hero.astro";
import CourseFilters from "../components/CourseFilters.astro";
import CourseCard from "../components/CourseCard.astro";
import Calendar from "../components/Calendar.astro";
import CourseModal from "../components/CourseModal.astro";
import Footer from "../components/Footer.astro";
import { courses } from "../data/courses";
---

<Layout>
  <Header />
  <CourseModal />
  <main>
    <Hero />

    <!-- Cursos Section -->
    <section class="section" id="cursos">
      <div class="container">
        <h2 class="section-title">Cursos Disponíveis</h2>
        <p class="section-subtitle">
          Explore os cursos gratuitos por área artística ou local
        </p>

        <CourseFilters />

        <div class="course-grid" id="course-grid">
          {courses.map((course) => <CourseCard course={course} />)}
        </div>

        <button class="load-more-btn" id="load-more-btn" style="display:none">
          <span class="material-symbols-outlined">expand_more</span>
          <span id="load-more-text">Carregar mais</span>
        </button>

        <div class="no-results" id="no-results" hidden>
          <div class="no-results-icon">
            <span class="material-symbols-outlined">search_off</span>
          </div>
          <p class="no-results-text">Nenhum curso encontrado</p>
          <p class="no-results-hint">
            Tente ajustar os filtros para ver mais resultados
          </p>
        </div>
      </div>
    </section>

    <!-- Agenda/Calendar Section -->
    <section class="section" id="agenda">
      <div class="container">
        <h2 class="section-title">Agenda</h2>
        <p class="section-subtitle">
          Visualize os cursos no calendário — clique em um dia para ver os
          detalhes
        </p>

        <Calendar />
      </div>
    </section>

    <!-- Sobre Section -->
    <section class="section section-about" id="sobre">
      <div class="container">
        <div class="about-content">
          <h2 class="section-title">Sobre este site</h2>
          <div class="about-text">
            <p>
              Este site foi criado como uma ferramenta independente para
              facilitar a consulta dos cursos oferecidos pela <strong
                >Escola Livre de Artes Arena da Cultura</strong
              >, um projeto da Prefeitura de Belo Horizonte em parceria com a
              Fundação de Educação, Artes e Cultura.
            </p>
            <p>
              Todos os cursos são <strong>gratuitos</strong> e acontecem em centros
              culturais espalhados pela cidade, além de atividades online pela plataforma
              EAD da PBH.
            </p>

            <div class="about-alert">
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><circle cx="12" cy="12" r="10"></circle><line
                  x1="12"
                  y1="8"
                  x2="12"
                  y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"
                ></line></svg
              >
              <div>
                <strong>Importante:</strong> Este site não possui vínculo oficial
                com a Prefeitura de Belo Horizonte. Para informações oficiais e inscrições,
                utilize os canais oficiais.
              </div>
            </div>

            <div class="about-actions">
              <a
                href="https://form.jotform.com/260393432980662"
                target="_blank"
                rel="noopener"
                class="btn btn-primary">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><path
                    d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                  ></path><path
                    d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                  ></path></svg
                >
                Formulário de Inscrição
              </a>
              <a
                href="https://prefeitura.pbh.gov.br/fundacao-municipal-de-cultura/escola-livre-de-artes"
                target="_blank"
                rel="noopener"
                class="btn btn-outline">
                Site Oficial
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<!-- Inline client scripts for filters -->
<script>
  // =========================
  // Filters
  // =========================
  const areaChips =
    document.querySelectorAll<HTMLButtonElement>("#area-chips .chip");
  const locationFilter = document.getElementById(
    "location-filter",
  ) as HTMLSelectElement;
  const courseGrid = document.getElementById("course-grid")!;
  const cards = document.querySelectorAll<HTMLElement>(".course-card");
  const noResults = document.getElementById("no-results")!;
  const counterNumber = document.getElementById("counter-number")!;
  const searchInput = document.getElementById(
    "search-input",
  ) as HTMLInputElement;

  let activeArea = "all";
  let activeLocation = "all";
  let searchQuery = "";

  // --- Load-more on mobile ---
  const INITIAL_SHOW = 15;
  const LOAD_MORE_STEP = 30;
  const loadMoreBtn = document.getElementById(
    "load-more-btn",
  ) as HTMLButtonElement;
  const loadMoreText = document.getElementById("load-more-text")!;
  let mobileLimit = INITIAL_SHOW;

  function isMobile() {
    return window.innerWidth < 768;
  }

  function hasActiveFilters() {
    return (
      activeArea !== "all" || activeLocation !== "all" || searchQuery !== ""
    );
  }

  function showLoadMore(show: boolean) {
    loadMoreBtn.style.display = show ? "" : "none";
  }

  function applyLoadMore() {
    if (hasActiveFilters()) {
      // Filtered: show all filtered, hide button
      showLoadMore(false);
      cards.forEach((card) => {
        if (card.dataset._filtered === "true") card.style.display = "";
      });
      return;
    }

    // Get filtered (visible) cards in DOM order
    const filtered: HTMLElement[] = [];
    cards.forEach((card) => {
      if (card.dataset._filtered === "true") filtered.push(card);
    });

    filtered.forEach((card, i) => {
      card.style.display = i < mobileLimit ? "" : "none";
    });

    const remaining = filtered.length - mobileLimit;
    if (remaining > 0) {
      showLoadMore(true);
      loadMoreText.textContent = `Carregar mais (${remaining})`;
    } else {
      showLoadMore(false);
    }
  }

  loadMoreBtn.addEventListener("click", () => {
    mobileLimit += LOAD_MORE_STEP;
    applyLoadMore();
  });

  window.addEventListener("resize", () => applyLoadMore());

  function applyFilters() {
    let visibleCount = 0;
    const query = searchQuery
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
    cards.forEach((card) => {
      const cardArea = card.dataset.area || "";
      const cardLocation = card.dataset.location || "";
      const cardName = (card.dataset.name || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
      const matchArea = activeArea === "all" || cardArea === activeArea;
      const matchLocation =
        activeLocation === "all" || cardLocation === activeLocation;
      const matchSearch = !query || cardName.includes(query);
      const visible = matchArea && matchLocation && matchSearch;
      // Mark filtered state, but don't set display yet (load-more handles it on mobile)
      card.dataset._filtered = visible ? "true" : "false";
      card.style.display = visible ? "" : "none";
      if (visible) visibleCount++;
    });
    // Reset mobile limit on filter change
    mobileLimit = INITIAL_SHOW;
    counterNumber.textContent = String(visibleCount);
    noResults.hidden = visibleCount > 0;
    courseGrid.style.display = visibleCount > 0 ? "" : "none";
    applyLoadMore();
  }

  areaChips.forEach((chip) => {
    chip.addEventListener("click", () => {
      areaChips.forEach((c) => {
        c.classList.remove("active");
        c.setAttribute("aria-checked", "false");
      });
      chip.classList.add("active");
      chip.setAttribute("aria-checked", "true");
      activeArea = chip.dataset.area || "all";
      applyFilters();
    });
  });

  // Listen for change on the underlying select (Tom Select triggers this)
  locationFilter.addEventListener("change", () => {
    activeLocation = locationFilter.value;
    applyFilters();
  });

  // Listen for search input
  const searchClear = document.getElementById("search-clear");

  searchInput.addEventListener("input", () => {
    searchQuery = searchInput.value.trim();
    if (searchClear) searchClear.style.display = searchQuery ? "flex" : "none";
    applyFilters();
  });

  if (searchClear) {
    searchClear.addEventListener("click", () => {
      searchInput.value = "";
      searchQuery = "";
      searchClear.style.display = "none";
      searchInput.focus();
      applyFilters();
    });
  }

  // Initialize count
  applyFilters();
</script>

<style>
  .course-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
  }

  .load-more-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    margin-top: var(--space-md);
    padding: 12px 20px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-md);
    background: var(--bg-card);
    color: var(--text-secondary);
    font-family: var(--font-sans);
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .load-more-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-light);
  }

  .load-more-btn .material-symbols-outlined {
    font-size: 20px;
  }

  @media (min-width: 640px) {
    .course-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .course-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  /* About section */
  .section-about {
    background: var(--bg-elevated);
  }

  .about-content {
    max-width: 680px;
  }

  .about-text {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .about-text p {
    font-size: 0.95rem;
    line-height: 1.7;
  }

  .about-text strong {
    color: var(--text-primary);
  }

  .about-alert {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: #fff8e1;
    border: 1px solid #ffe082;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    color: #5d4037;
    line-height: 1.6;
  }

  .about-alert svg {
    flex-shrink: 0;
    margin-top: 2px;
    color: #f57f17;
  }

  .about-alert strong {
    color: #e65100;
  }

  .about-actions {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
    padding-top: var(--space-sm);
  }
</style>
