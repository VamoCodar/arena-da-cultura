---
/**
 * CourseModal — overlay modal for course details + share
 * Rendered once in the page; populated via JS when a card is clicked.
 * Deep-linkable through #curso-{slug} in the URL.
 */
import { courses, AREA_COLORS, AREA_ICONS, JOTFORM_IDS } from "../data/courses";

// Serialize only the fields we need client-side
const coursesJSON = JSON.stringify(
  courses.map((c) => ({
    id: c.id,
    name: c.name,
    area: c.area,
    location: c.location,
    schedule: c.schedule,
    ageRange: c.ageRange,
    enrollmentUrl: c.enrollmentUrl,
    startDate: c.startDate,
    endDate: c.endDate,
    daysOfWeek: c.daysOfWeek,
    isRecurring: c.isRecurring,
    specificDates: c.specificDates,
    extraMeetings: c.extraMeetings,
  })),
);
const areaColorsJSON = JSON.stringify(AREA_COLORS);
const areaIconsJSON = JSON.stringify(AREA_ICONS);
const jotformIdsJSON = JSON.stringify(JOTFORM_IDS);
---

<!-- Modal Backdrop -->
<div
  class="modal-backdrop"
  id="course-modal"
  role="dialog"
  aria-modal="true"
  aria-hidden="true">
  <div class="modal-container">
    <!-- Close -->
    <button class="modal-close" id="modal-close" aria-label="Fechar">
      <span class="material-symbols-outlined">close</span>
    </button>

    <!-- Content (filled via JS) -->
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<script
  define:vars={{ coursesJSON, areaColorsJSON, areaIconsJSON, jotformIdsJSON }}
>
  window.__MODAL_COURSES__ = coursesJSON;
  window.__MODAL_AREA_COLORS__ = areaColorsJSON;
  window.__MODAL_AREA_ICONS__ = areaIconsJSON;
  window.__MODAL_JOTFORM_IDS__ = jotformIdsJSON;
</script>

<script>
  import { formatAgeBadge, ageBadgeHTML, areaBadgeHTML } from "../utils/badges";

  const allCourses = JSON.parse((window as any).__MODAL_COURSES__);
  const areaColors = JSON.parse((window as any).__MODAL_AREA_COLORS__);
  const areaIcons = JSON.parse((window as any).__MODAL_AREA_ICONS__);
  const jotformIds = JSON.parse((window as any).__MODAL_JOTFORM_IDS__);

  const backdrop = document.getElementById("course-modal")!;
  const body = document.getElementById("modal-body")!;
  const closeBtn = document.getElementById("modal-close")!;

  // --- Helpers ---
  function fmtDate(d: string): string {
    return new Date(d + "T12:00:00")
      .toLocaleDateString("pt-BR", { day: "2-digit", month: "short" })
      .replace(/\.$/, "");
  }

  function fmtDateLong(d: string): string {
    return new Date(d + "T12:00:00").toLocaleDateString("pt-BR", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    });
  }

  function getEnrollUrl(course: any): string {
    const anchor = jotformIds[course.id];
    return anchor ? `${course.enrollmentUrl}#${anchor}` : course.enrollmentUrl;
  }

  function isOnline(loc: string): boolean {
    return loc.includes("Online") || loc.includes("EAD");
  }

  function getMapsUrl(loc: string): string | null {
    return isOnline(loc)
      ? null
      : `https://www.google.com/maps/search/${encodeURIComponent(loc + ", Belo Horizonte, MG")}`;
  }

  function slugify(text: string): string {
    return text
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "");
  }

  function getShareUrl(course: any): string {
    const url = new URL(window.location.href);
    url.hash = `curso-${slugify(course.name)}`;
    return url.toString();
  }

  // --- Mini Calendar ---
  function getCourseDates(course: any): Set<string> {
    const dates = new Set<string>();
    if (!course.isRecurring && course.specificDates?.length) {
      course.specificDates.forEach((d: string) => dates.add(d));
    } else if (
      course.startDate &&
      course.endDate &&
      course.daysOfWeek?.length
    ) {
      const start = new Date(course.startDate + "T12:00:00");
      const end = new Date(course.endDate + "T12:00:00");
      const cur = new Date(start);
      while (cur <= end) {
        if (course.daysOfWeek.includes(cur.getDay())) {
          dates.add(cur.toISOString().slice(0, 10));
        }
        cur.setDate(cur.getDate() + 1);
      }
    }
    return dates;
  }

  function buildMiniCalendar(course: any, areaColor: any): string {
    const dates = getCourseDates(course);
    if (dates.size === 0) return "";

    // Determine which months to show
    const sorted = [...dates].sort();
    const firstDate = new Date(sorted[0] + "T12:00:00");
    const lastDate = new Date(sorted[sorted.length - 1] + "T12:00:00");

    const months: { year: number; month: number }[] = [];
    let y = firstDate.getFullYear(),
      m = firstDate.getMonth();
    const ey = lastDate.getFullYear(),
      em = lastDate.getMonth();
    while (y < ey || (y === ey && m <= em)) {
      months.push({ year: y, month: m });
      m++;
      if (m > 11) {
        m = 0;
        y++;
      }
    }

    const dayNames = ["D", "S", "T", "Q", "Q", "S", "S"];
    const monthNames = [
      "Janeiro",
      "Fevereiro",
      "Março",
      "Abril",
      "Maio",
      "Junho",
      "Julho",
      "Agosto",
      "Setembro",
      "Outubro",
      "Novembro",
      "Dezembro",
    ];
    const today = new Date().toISOString().slice(0, 10);

    let html = `<div class="mini-cal-wrap">`;
    html += `<div class="mini-cal-label"><span class="material-symbols-outlined" style="font-size:16px">calendar_month</span> Calendário do curso</div>`;
    html += `<div class="mini-cal-months">`;

    for (const { year, month } of months) {
      const mName = monthNames[month];
      const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      html += `<div class="mini-cal">`;
      html += `<div class="mini-cal-header">${mName} ${year}</div>`;
      html += `<div class="mini-cal-grid">`;

      // Day-of-week headers
      for (const dn of dayNames) {
        html += `<span class="mini-cal-dow">${dn}</span>`;
      }

      // Empty cells before 1st
      for (let i = 0; i < firstDay; i++) {
        html += `<span class="mini-cal-empty"></span>`;
      }

      // Days
      for (let d = 1; d <= daysInMonth; d++) {
        const iso = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
        const isActive = dates.has(iso);
        const isToday = iso === today;
        let cls = "mini-cal-day";
        if (isActive) cls += " active";
        if (isToday) cls += " today";
        const style = isActive
          ? `background:${areaColor.bg};color:${areaColor.text};font-weight:700`
          : "";
        html += `<span class="${cls}" ${style ? `style="${style}"` : ""}>${d}</span>`;
      }

      html += `</div></div>`;
    }

    html += `</div></div>`;
    return html;
  }

  // --- Render ---
  function renderModal(course: any) {
    const c = areaColors[course.area] || areaColors["Artes Visuais"];
    const icon = areaIcons[course.area] || "auto_awesome";
    const enrollUrl = getEnrollUrl(course);
    const mapsUrl = getMapsUrl(course.location);
    const shareUrl = getShareUrl(course);

    let dateHTML = "";
    if (course.startDate && course.endDate) {
      dateHTML = `
        <div class="modal-info-row">
          <span class="material-symbols-outlined modal-info-icon">date_range</span>
          <span><strong>${fmtDateLong(course.startDate)}</strong> a <strong>${fmtDateLong(course.endDate)}</strong></span>
        </div>`;
    }
    if (course.specificDates && course.specificDates.length > 0) {
      const dates = course.specificDates
        .map((d: string) => fmtDate(d))
        .join(", ");
      dateHTML += `
        <div class="modal-info-row">
          <span class="material-symbols-outlined modal-info-icon">event</span>
          <span>${dates}</span>
        </div>`;
    }

    const locationHTML = mapsUrl
      ? `<a href="${mapsUrl}" target="_blank" rel="noopener" class="modal-link">${course.location} <span class="material-symbols-outlined" style="font-size:13px;vertical-align:-2px">open_in_new</span></a>`
      : `<span>${course.location}</span>`;

    body.innerHTML = `
      <div class="modal-header">
        ${areaBadgeHTML(course.area, c, icon)}
        ${isOnline(course.location) ? '<span class="online-badge"><span class="material-symbols-outlined" style="font-size:12px">language</span> Online</span>' : ""}
        ${ageBadgeHTML(course.ageRange)}
      </div>

      <h2 class="modal-title">${course.name}</h2>

      <div class="modal-info">
        ${dateHTML}
        <div class="modal-info-row">
          <span class="material-symbols-outlined modal-info-icon">schedule</span>
          <span>${course.schedule}</span>
        </div>
        <div class="modal-info-row">
          <span class="material-symbols-outlined modal-info-icon">location_on</span>
          ${locationHTML}
        </div>
        <div class="modal-info-row">
          <span class="material-symbols-outlined modal-info-icon">person</span>
          <span>${course.ageRange}</span>
        </div>
        ${
          course.extraMeetings
            ? `
        <div class="modal-info-row modal-info-extra">
          <span class="material-symbols-outlined modal-info-icon">more_time</span>
          <span>${course.extraMeetings}</span>
        </div>`
            : ""
        }
      </div>

      ${buildMiniCalendar(course, c)}

      <div class="modal-actions">
        <a href="${enrollUrl}" target="_blank" rel="noopener" class="modal-btn modal-btn-primary">
          <span class="material-symbols-outlined">edit_note</span>
          Inscrever-se
        </a>
        <button class="modal-btn modal-btn-share" id="modal-share-btn" data-url="${shareUrl}" data-title="${course.name} — Arena da Cultura">
          <span class="material-symbols-outlined">share</span>
          Compartilhar
        </button>
   
      </div>

      <div class="modal-share-toast" id="modal-share-toast">Link copiado!</div>
    `;

    // Share button handler
    const shareBtn = document.getElementById("modal-share-btn")!;
    shareBtn.addEventListener("click", async () => {
      const url = shareBtn.dataset.url!;
      const title = shareBtn.dataset.title!;

      if (navigator.share) {
        try {
          await navigator.share({ title, url });
        } catch {}
      } else {
        await navigator.clipboard.writeText(url);
        const toast = document.getElementById("modal-share-toast")!;
        toast.classList.add("visible");
        setTimeout(() => toast.classList.remove("visible"), 2000);
      }
    });
  }

  // --- Open / Close ---
  function openModal(courseId: number) {
    const course = allCourses.find((c: any) => c.id === courseId);
    if (!course) return;
    renderModal(course);
    backdrop.setAttribute("aria-hidden", "false");
    backdrop.classList.add("open");
    document.body.style.overflow = "hidden";
    history.replaceState(null, "", `#curso-${slugify(course.name)}`);
  }

  function closeModal() {
    backdrop.setAttribute("aria-hidden", "true");
    backdrop.classList.remove("open");
    document.body.style.overflow = "";
    // Clean hash without scrolling
    history.replaceState(
      null,
      "",
      window.location.pathname + window.location.search,
    );
  }

  closeBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e) => {
    if (e.target === backdrop) closeModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && backdrop.classList.contains("open")) closeModal();
  });

  // --- Card click delegation ---
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    // Don't intercept clicks on links/buttons inside the card
    if (target.closest("a") || target.closest("button")) return;
    // Course card (grid)
    const card = target.closest<HTMLElement>(".course-card");
    if (card) {
      const id = Number(card.dataset.courseId);
      if (id) openModal(id);
      return;
    }
    // Listing event (agenda sidebar)
    const listing = target.closest<HTMLElement>(".listing-event");
    if (listing) {
      const id = Number(listing.dataset.courseId);
      if (id) openModal(id);
    }
  });

  // --- Deep link: open modal if URL has #curso-{slug} ---
  function checkHash() {
    const match = window.location.hash.match(/^#curso-(.+)$/);
    if (match) {
      const hashSlug = match[1];
      // Try slug match first, fall back to legacy numeric ID
      const course = allCourses.find((c: any) => slugify(c.name) === hashSlug)
        || (/^\d+$/.test(hashSlug) ? allCourses.find((c: any) => c.id === Number(hashSlug)) : null);
      if (course) {
        requestAnimationFrame(() => openModal(course.id));
      }
    }
  }
  checkHash();
  window.addEventListener("hashchange", checkHash);
</script>

<style>
  /* ========== Backdrop ========== */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.45);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 200ms ease,
      visibility 200ms ease;
    padding: var(--space-md);
  }

  .modal-backdrop.open {
    opacity: 1;
    visibility: visible;
  }

  /* ========== Container ========== */
  .modal-container {
    position: relative;
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 520px;
    width: 100%;
    max-height: 98vh;
    overflow-y: auto;
    padding: var(--space-md);
    transform: translateY(16px) scale(0.97);
    transition: transform 200ms ease;
  }

  .modal-backdrop.open .modal-container {
    transform: translateY(0) scale(1);
  }

  /* ========== Close button ========== */
  .modal-close {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border: none;
    border-radius: var(--radius-sm);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition:
      background 150ms ease,
      color 150ms ease;
  }

  .modal-close:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
  }

  .modal-close .material-symbols-outlined {
    font-size: 22px;
  }
</style>

<!-- Styles for inner content (global because it's injected via innerHTML) -->
<style is:global>
  /* Header badges row */
  .modal-header {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  /* Title */
  .modal-title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.25rem;
    line-height: 1.3;
    color: var(--text-primary);
    margin-bottom: 16px;
  }

  /* Info rows */
  .modal-info {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 8px;
    padding: 8px;
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
  }

  .modal-info-row {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .modal-info-icon {
    font-size: 18px;
    color: var(--text-muted);
    flex-shrink: 0;
    margin-top: 1px;
  }

  .modal-info-row strong {
    color: var(--text-primary);
    font-weight: 600;
  }

  .modal-info-extra {
    padding-top: 8px;
    border-top: 1px dashed var(--border);
    font-style: italic;
    color: var(--text-muted);
  }

  .modal-info-extra .modal-info-icon {
    color: var(--accent);
  }

  .modal-link {
    color: var(--text-secondary);
    text-decoration: none;
    transition: color 150ms ease;
  }

  .modal-link:hover {
    color: var(--accent);
    text-decoration: underline;
  }

  /* Action buttons */
  .modal-actions {
    display: flex;
    gap: 4px;
    justify-content: space-between;
  }

  .modal-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 150ms ease;
    font-family: var(--font-sans);
    line-height: 1;
  }

  .modal-btn .material-symbols-outlined {
    font-size: 18px;
  }

  .modal-btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .modal-btn-primary:hover {
    background: var(--accent-hover);
  }

  .modal-btn-share {
    background: var(--bg-elevated);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }

  .modal-btn-share:hover {
    background: var(--border);
  }

  .modal-btn-whatsapp {
    background: #25d366;
    color: #fff;
  }

  .modal-btn-whatsapp:hover {
    background: #1da851;
  }

  .modal-btn-whatsapp svg {
    flex-shrink: 0;
  }

  /* Toast */
  .modal-share-toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    padding: 10px 20px;
    background: var(--text-primary);
    color: #fff;
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    font-weight: 600;
    opacity: 0;
    pointer-events: none;
    transition:
      opacity 200ms ease,
      transform 200ms ease;
    z-index: 10001;
  }

  .modal-share-toast.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* ========== Mini Calendar ========== */
  .mini-cal-wrap {
    margin-bottom: 20px;
  }

  .mini-cal-label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-bottom: 10px;
  }

  .mini-cal-months {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 4px;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }

  .mini-cal-months::-webkit-scrollbar {
    height: 4px;
  }

  .mini-cal-months::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
  }

  .mini-cal {
    flex: 0 0 auto;
    min-width: 210px;
    scroll-snap-align: start;
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
    padding: 4px;
  }
  @media (max-width: 720px) {
    .fc-daygrid-day-bottom {
      pointer-events: none;
    }
  }

  .mini-cal-header {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 0.8rem;
    color: var(--text-primary);
    text-align: center;
    margin-bottom: 6px;
  }

  .mini-cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    text-align: center;
  }

  .mini-cal-dow {
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-muted);
    padding: 2px 0;
  }

  .mini-cal-empty {
    padding: 2px;
  }

  .mini-cal-day {
    font-size: 0.7rem;
    padding: 3px 2px;
    border-radius: 4px;
    color: var(--text-secondary);
    line-height: 1.4;
    transition: background 100ms ease;
  }

  .mini-cal-day.active {
    border-radius: 50%;
    font-weight: 700;
  }

  .mini-cal-day.today {
    box-shadow: inset 0 0 0 1.5px var(--accent);
    border-radius: 50%;
  }
  .modal-header .badge {
    height: 24px;
    display: flex;
    align-items: center;
    padding: 0 10px;
  }
  .modal-header .age-badge {
    height: 24px;
    display: flex;
    align-items: center;
    padding: 0 10px;
  }
</style>
