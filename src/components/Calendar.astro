---
import {
  courses,
  areas,
  locations,
  AREA_COLORS,
  AREA_ICONS,
} from "../data/courses";

// Build FullCalendar events array at build time
type FCEvent = {
  id: string;
  title: string;
  start: string;
  end?: string;
  extendedProps: {
    area: string;
    location: string;
    time: string;
    ageRange: string;
    schedule: string;
    courseId: number;
  };
  backgroundColor: string;
  borderColor: string;
  textColor: string;
};

const fcEvents: FCEvent[] = [];

for (const course of courses) {
  const colors = AREA_COLORS[course.area] || AREA_COLORS["Artes Visuais"];

  if (
    course.isRecurring &&
    course.startDate &&
    course.endDate &&
    course.daysOfWeek.length > 0
  ) {
    const start = new Date(course.startDate + "T12:00:00");
    const end = new Date(course.endDate + "T12:00:00");
    const current = new Date(start);
    while (current <= end) {
      if (course.daysOfWeek.includes(current.getDay())) {
        const dateStr = current.toISOString().split("T")[0];
        fcEvents.push({
          id: `${course.id}-${dateStr}`,
          title: course.name,
          start: dateStr,
          extendedProps: {
            area: course.area,
            location: course.location,
            time: `${course.startTime} – ${course.endTime}`,
            ageRange: course.ageRange,
            schedule: course.schedule,
            courseId: course.id,
          },
          backgroundColor: colors.bg,
          borderColor: colors.dot,
          textColor: colors.text,
        });
      }
      current.setDate(current.getDate() + 1);
    }
  }

  for (const dateStr of course.specificDates) {
    fcEvents.push({
      id: `${course.id}-${dateStr}`,
      title: course.name,
      start: dateStr,
      extendedProps: {
        area: course.area,
        location: course.location,
        time: `${course.startTime} – ${course.endTime}`,
        ageRange: course.ageRange,
        schedule: course.schedule,
        courseId: course.id,
      },
      backgroundColor: colors.bg,
      borderColor: colors.dot,
      textColor: colors.text,
    });
  }
}

const eventsJSON = JSON.stringify(fcEvents);
const areaColorsJSON = JSON.stringify(AREA_COLORS);
const areaIconsJSON = JSON.stringify(AREA_ICONS);
const locationsJSON = JSON.stringify(locations);
---

<!-- Calendar Filters -->
<div class="cal-filters">
  <div
    class="cal-filter-chips"
    id="cal-area-chips"
    role="radiogroup"
    aria-label="Filtrar agenda por área">
    <button
      class="cal-chip active"
      data-area="all"
      role="radio"
      aria-checked="true">
      Todas as Áreas
    </button>
    {
      areas.map((area) => {
        const c = AREA_COLORS[area] || AREA_COLORS["Artes Visuais"];
        const icon = AREA_ICONS[area] || "auto_awesome";
        return (
          <button
            class="cal-chip"
            data-area={area}
            role="radio"
            aria-checked="false"
            style={`--chip-bg:${c.bg};--chip-text:${c.text};--chip-dot:${c.dot}`}>
            <span class="chip-icon material-symbols-outlined">{icon}</span>{" "}
            {area}
          </button>
        );
      })
    }
  </div>
  <div class="cal-filter-row">
    <div class="cal-select-wrapper">
      <select
        id="cal-location-filter"
        class="cal-filter-select"
        aria-label="Filtrar agenda por local">
        <option value="all">Todos os Locais</option>
        {locations.map((loc) => <option value={loc}>{loc}</option>)}
      </select>
    </div>
  </div>
</div>

<div class="agenda-layout">
  <!-- Calendar side -->
  <div class="agenda-calendar">
    <div id="fullcalendar"></div>
  </div>

  <!-- Day listing side -->
  <div class="agenda-listing" id="agenda-listing">
    <div class="listing-header">
      <h3 class="listing-date" id="listing-date">Selecione um dia</h3>
      <span class="listing-count" id="listing-count"></span>
    </div>
    <div class="listing-placeholder" id="listing-placeholder">
      <div class="listing-placeholder-icon">
        <span class="material-symbols-outlined">calendar_month</span>
      </div>
      <p>Clique em um dia no calendário para ver os cursos desse dia</p>
    </div>
    <div class="listing-items" id="listing-items"></div>
  </div>
</div>

<script
  define:vars={{ eventsJSON, areaColorsJSON, areaIconsJSON, locationsJSON }}
>
  // Data is injected server-side
  window.__FC_EVENTS__ = eventsJSON;
  window.__AREA_COLORS__ = areaColorsJSON;
  window.__AREA_ICONS__ = areaIconsJSON;
  window.__CAL_LOCATIONS__ = locationsJSON;
</script>

<script>
  import { Calendar } from "@fullcalendar/core";
  import dayGridPlugin from "@fullcalendar/daygrid";
  import listPlugin from "@fullcalendar/list";
  import interactionPlugin from "@fullcalendar/interaction";
  import TomSelect from "tom-select";
  import "tom-select/dist/css/tom-select.default.css";
  import { ageBadgeHTML, areaBadgeHTML } from "../utils/badges";

  const allEvents = JSON.parse((window as any).__FC_EVENTS__);
  const areaColors = JSON.parse((window as any).__AREA_COLORS__);
  const areaIcons = JSON.parse((window as any).__AREA_ICONS__);

  const calendarEl = document.getElementById("fullcalendar")!;
  const listingDate = document.getElementById("listing-date")!;
  const listingCount = document.getElementById("listing-count")!;
  const listingPlaceholder = document.getElementById("listing-placeholder")!;
  const listingItems = document.getElementById("listing-items")!;

  // --- Calendar filter state ---
  let calActiveArea = "all";
  let calActiveLocation = "all";
  let selectedDateStr: string | null = null;

  function getFilteredEvents() {
    return allEvents.filter((e: any) => {
      const matchArea =
        calActiveArea === "all" || e.extendedProps.area === calActiveArea;
      const matchLoc =
        calActiveLocation === "all" ||
        e.extendedProps.location === calActiveLocation;
      return matchArea && matchLoc;
    });
  }

  function showDayEvents(dateStr: string) {
    selectedDateStr = dateStr;
    const filtered = getFilteredEvents();
    const dayEvents = filtered.filter((e: any) => e.start === dateStr);
    const d = new Date(dateStr + "T12:00:00");
    const formatted = d.toLocaleDateString("pt-BR", {
      weekday: "long",
      day: "numeric",
      month: "long",
    });
    listingDate.textContent =
      formatted.charAt(0).toUpperCase() + formatted.slice(1);
    listingCount.textContent =
      dayEvents.length > 0
        ? `${dayEvents.length} curso${dayEvents.length > 1 ? "s" : ""}`
        : "";

    if (dayEvents.length === 0) {
      listingPlaceholder.style.display = "";
      listingPlaceholder.querySelector("p")!.textContent =
        "Nenhum curso neste dia";
      listingItems.innerHTML = "";
      return;
    }

    listingPlaceholder.style.display = "none";

    // Sort by area then time
    dayEvents.sort((a: any, b: any) => {
      const areaCompare = a.extendedProps.area.localeCompare(
        b.extendedProps.area,
      );
      if (areaCompare !== 0) return areaCompare;
      return a.extendedProps.time.localeCompare(b.extendedProps.time);
    });

    listingItems.innerHTML = dayEvents
      .map((e: any) => {
        const c =
          areaColors[e.extendedProps.area] || areaColors["Artes Visuais"];
        const icon = areaIcons[e.extendedProps.area] || "auto_awesome";
        return `
        <div class="listing-event" data-course-id="${e.extendedProps.courseId}">
          <div class="listing-event-top">
            ${areaBadgeHTML(e.extendedProps.area, c, icon)}
            <span class="listing-event-time"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:-2px">schedule</span> ${e.extendedProps.time}</span>
          </div>
          <div class="listing-event-name">${e.title}</div>
          <div class="listing-event-meta">
            <span class="listing-event-location"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:-2px">location_on</span> ${e.extendedProps.location}</span>
            ${ageBadgeHTML(e.extendedProps.ageRange)}
          </div>
        </div>
      `;
      })
      .join("");

    // Scroll listing into view on mobile
    if (window.innerWidth < 768) {
      listingItems.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
  }

  function applyCalendarFilters() {
    const filtered = getFilteredEvents();
    calendar.removeAllEventSources();
    calendar.addEventSource(filtered);
    // Refresh the day listing if a day was selected
    if (selectedDateStr) {
      showDayEvents(selectedDateStr);
    }
  }

  // Determine initial date: use today if within valid range, otherwise range start
  const validStart = "2026-02-01";
  const validEnd = "2026-08-01";
  const todayStr = new Date().toISOString().slice(0, 10);
  const initialDate = (todayStr >= validStart && todayStr < validEnd) ? todayStr : validStart;

  const calendar = new Calendar(calendarEl, {
    plugins: [dayGridPlugin, listPlugin, interactionPlugin],
    initialView: "dayGridMonth",
    initialDate,
    locale: "pt-br",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,listWeek",
    },
    buttonText: {
      today: "Hoje",
      month: "Mês",
      list: "Lista",
    },
    validRange: {
      start: "2026-02-01",
      end: "2026-08-01",
    },
    events: allEvents,
    height: "auto",
    dayMaxEventRows: 3,
    moreLinkText: (n: number) => `+${n} mais`,
    eventDisplay: "block",
    dateClick: function (info: any) {
      showDayEvents(info.dateStr);
      // Highlight selected day
      document
        .querySelectorAll(".fc-day-selected")
        .forEach((el) => el.classList.remove("fc-day-selected"));
      const dayEl = info.dayEl;
      if (dayEl) dayEl.classList.add("fc-day-selected");
      // On mobile, scroll directly to listing
      if (window.innerWidth < 768) {
        document
          .getElementById("agenda-listing")
          ?.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    },
    eventClick: function (info: any) {
      info.jsEvent.preventDefault();
      showDayEvents(info.event.startStr);
      // Highlight
      document
        .querySelectorAll(".fc-day-selected")
        .forEach((el) => el.classList.remove("fc-day-selected"));
      const dateStr = info.event.startStr;
      const dayCell = calendarEl.querySelector(`[data-date="${dateStr}"]`);
      if (dayCell) dayCell.classList.add("fc-day-selected");
      // On mobile, scroll directly to listing
      if (window.innerWidth < 768) {
        document
          .getElementById("agenda-listing")
          ?.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    },
    eventDidMount: function (info: any) {
      const props = info.event.extendedProps;
      // Only show tooltip on desktop; mobile clicks go straight to listing
      if (window.innerWidth >= 768) {
        info.el.title = `${props.area} — ${info.event.title}\n${props.time} · ${props.location}`;
      } else {
        info.el.title = "";
        info.el.removeAttribute("title");
      }
    },
  });

  calendar.render();

  // Auto-select today's date on load
  (() => {
    const dateToSelect = (todayStr >= validStart && todayStr < validEnd) ? todayStr : validStart;
    showDayEvents(dateToSelect);
    const todayCell = calendarEl.querySelector(`[data-date="${dateToSelect}"]`);
    if (todayCell) todayCell.classList.add("fc-day-selected");
  })();

  // --- Calendar filter wiring ---
  const calAreaChips = document.querySelectorAll<HTMLButtonElement>(
    "#cal-area-chips .cal-chip",
  );
  const calLocationSelect = document.getElementById(
    "cal-location-filter",
  ) as HTMLSelectElement;

  // Tom Select for calendar location dropdown
  if (calLocationSelect) {
    new TomSelect(calLocationSelect, {
      controlInput: undefined,
      allowEmptyOption: true,
      render: {
        option: function (data: any, escape: (s: string) => string) {
          return `<div class="ts-option-item">
            <span class="material-symbols-outlined" style="font-size:16px;vertical-align:-3px;margin-right:4px;color:var(--text-muted)">location_on</span>
            ${escape(data.text)}
          </div>`;
        },
        item: function (data: any, escape: (s: string) => string) {
          return `<div class="ts-item-inner">
            <span class="material-symbols-outlined" style="font-size:16px;vertical-align:-3px;margin-right:4px;color:var(--text-muted)">location_on</span>
            ${escape(data.text)}
          </div>`;
        },
      },
    });
  }

  calAreaChips.forEach((chip) => {
    chip.addEventListener("click", () => {
      calAreaChips.forEach((c) => {
        c.classList.remove("active");
        c.setAttribute("aria-checked", "false");
      });
      chip.classList.add("active");
      chip.setAttribute("aria-checked", "true");
      calActiveArea = chip.dataset.area || "all";
      applyCalendarFilters();
    });
  });

  calLocationSelect.addEventListener("change", () => {
    calActiveLocation = calLocationSelect.value;
    applyCalendarFilters();
  });
</script>

<style is:global>
  /* FullCalendar theme overrides */
  .fc {
    --fc-border-color: var(--border);
    --fc-button-bg-color: white;
    --fc-button-border-color: var(--border);
    --fc-button-text-color: var(--text-secondary);
    --fc-button-hover-bg-color: var(--accent-light);
    --fc-button-hover-border-color: var(--accent);
    --fc-button-active-bg-color: var(--accent);
    --fc-button-active-border-color: var(--accent);
    --fc-button-active-text-color: white;
    --fc-today-bg-color: rgba(45, 90, 39, 0.06);
    --fc-page-bg-color: transparent;
    --fc-neutral-bg-color: var(--bg-elevated);
    --fc-event-border-color: transparent;
    font-family: var(--font-sans) !important;
    font-size: 0.85rem;
  }

  .fc .fc-toolbar-title {
    font-family: var(--font-display) !important;
    font-size: 1.25rem !important;
    font-weight: 400;
  }

  .fc .fc-button {
    font-family: var(--font-sans) !important;
    font-size: 0.8rem !important;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: var(--radius-sm) !important;
    transition: all 150ms ease;
    box-shadow: none !important;
    text-transform: none;
  }

  .fc .fc-button:focus {
    box-shadow: 0 0 0 2px var(--accent) !important;
  }

  .fc .fc-col-header-cell {
    padding: 8px 0;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-muted);
  }

  .fc .fc-col-header-cell-cushion {
    color: var(--text-muted);
    text-decoration: none !important;
  }

  .fc .fc-daygrid-day-number {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
    padding: 4px 8px;
    text-decoration: none !important;
  }

  .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number {
    color: var(--accent);
    font-weight: 700;
  }

  .fc .fc-daygrid-day {
    cursor: pointer;
    transition: background 150ms ease;
    min-height: 80px;
  }

  .fc .fc-daygrid-day:hover {
    background: var(--accent-light) !important;
  }

  .fc .fc-daygrid-day.fc-day-selected {
    background: rgba(45, 90, 39, 0.1) !important;
    outline: 2px solid var(--accent);
    outline-offset: -2px;
    border-radius: 4px;
  }

  .fc .fc-daygrid-event {
    border-radius: 4px !important;
    padding: 1px 4px;
    font-size: 0.7rem !important;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: 1px;
    cursor: pointer;
    border-left-width: 3px !important;
    border-left-style: solid !important;
  }

  .fc .fc-daygrid-event .fc-event-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .fc .fc-more-link {
    font-size: 0.7rem !important;
    font-weight: 600;
    color: var(--accent) !important;
  }

  /* List view */
  .fc .fc-list-event-title a {
    color: var(--text-primary) !important;
    font-weight: 600;
    text-decoration: none !important;
  }

  .fc .fc-list-day-cushion {
    background: var(--bg-elevated) !important;
    font-weight: 600;
  }

  .fc .fc-list-event-dot {
    border-radius: 50%;
  }

  .fc .fc-list-event:hover td {
    background: var(--accent-light) !important;
  }

  /* Mobile toolbar */
  @media (max-width: 640px) {
    .fc .fc-toolbar {
      flex-direction: column;
      gap: 8px;
    }

    .fc .fc-toolbar-chunk {
      display: flex;
      justify-content: center;
    }

    .fc .fc-toolbar-title {
      font-size: 1.1rem !important;
    }

    .fc .fc-daygrid-day {
      min-height: 60px;
    }

    /* Dot mode on mobile: hide text, show filled colored dot */
    .fc .fc-daygrid-event {
      font-size: 0 !important;
      padding: 0 !important;
      width: 8px;
      height: 8px;
      border-radius: 50% !important;
      display: inline-block !important;
      margin: 1px 1px !important;
      border-left-width: 0 !important;
      min-height: 0 !important;
      border: none !important;
    }

    .fc .fc-daygrid-event .fc-event-title,
    .fc .fc-daygrid-event .fc-event-main-frame {
      display: none !important;
    }

    .fc .fc-daygrid-event-harness {
      display: inline-flex !important;
      width: auto !important;
      margin: 0 !important;
    }

    .fc .fc-daygrid-day-events {
      display: flex !important;
      flex-wrap: wrap;
      gap: 2px;
      justify-content: center;
      padding: 2px !important;
      min-height: 0 !important;
    }

    .fc .fc-daygrid-event-dot {
      display: none !important;
    }

    .fc .fc-more-link {
      font-size: 0.6rem !important;
    }
  }
</style>

<style>
  /* Calendar filters */
  .cal-filters {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .cal-filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .cal-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 8px 16px;
    border: 1.5px solid var(--chip-dot, var(--border));
    border-radius: var(--radius-full);
    background: white;
    font-family: var(--font-sans);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--chip-text, var(--text-secondary));
    cursor: pointer;
    white-space: nowrap;
    transition: all var(--transition-fast);
  }

  .cal-chip .chip-icon {
    font-size: 16px;
    line-height: 1;
  }

  .cal-chip .chip-icon.material-symbols-outlined {
    font-size: 16px;
    vertical-align: -2px;
  }

  .cal-chip:hover {
    background: var(--chip-bg, var(--accent-light));
    border-color: var(--chip-dot, var(--accent));
    color: var(--chip-text, var(--accent));
  }

  .cal-chip.active {
    background: var(--chip-text, var(--accent));
    border-color: var(--chip-text, var(--accent));
    color: white;
  }

  .cal-chip[data-area="all"] {
    --chip-dot: var(--border);
    --chip-text: var(--text-secondary);
    --chip-bg: var(--accent-light);
  }

  .cal-chip[data-area="all"]:hover {
    --chip-dot: var(--accent);
    --chip-text: var(--accent);
  }

  .cal-chip[data-area="all"].active {
    --chip-text: var(--accent);
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .cal-filter-row {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .cal-select-wrapper {
    flex: 1;
    max-width: 320px;
  }

  .agenda-layout {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .agenda-calendar {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--space-md);

    min-width: 0;
  }

  .agenda-listing {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    display: flex;
    flex-direction: column;
    min-height: 300px;
  }

  .listing-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border);
  }

  .listing-date {
    font-family: var(--font-sans);
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-primary);
  }

  .listing-count {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--accent);
    background: var(--accent-light);
    padding: 2px 10px;
    border-radius: var(--radius-full);
  }

  .listing-placeholder {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text-muted);
    gap: var(--space-sm);
    padding: var(--space-xl);
  }

  .listing-placeholder-icon {
    font-size: 2.5rem;
    opacity: 0.4;
  }

  .listing-placeholder p {
    font-size: 0.875rem;
    max-width: 240px;
  }

  .listing-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    overflow-y: auto;
    max-height: 500px;
  }

  @media (min-width: 768px) {
    .agenda-layout {
      flex-direction: row;
      align-items: flex-start;
    }

    .agenda-calendar {
      flex: 3;
      padding: var(--space-lg);
    }

    .agenda-listing {
      flex: 2;
      position: sticky;
      top: calc(var(--header-height) + 1rem);
      max-height: calc(100vh - var(--header-height) - 2rem);
      padding: var(--space-lg);
    }

    .listing-items {
      max-height: none;
      overflow-y: auto;
      flex: 1;
    }
  }

  @media (min-width: 1024px) {
    .agenda-calendar {
      flex: 2;
    }

    .agenda-listing {
      flex: 1;
    }
  }
</style>

<style is:global>
  /* Listing event items — card-like style */
  .listing-event {
    position: relative;
    padding: var(--space-md);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .listing-event:hover {
    border-color: var(--border-hover);
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }

  .listing-event-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-sm);
  }

  .listing-event-time {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    white-space: nowrap;
  }

  .listing-event-name {
    font-family: var(--font-sans);
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
    line-height: 1.35;
  }

  .listing-event-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-sm);
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .listing-event-location {
    display: inline-flex;
    align-items: center;
    gap: 3px;
  }
</style>
