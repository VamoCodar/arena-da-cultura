---
import { courses, AREA_COLORS, AREA_ICONS } from '../data/courses';

// Build FullCalendar events array at build time
type FCEvent = {
  id: string;
  title: string;
  start: string;
  end?: string;
  extendedProps: {
    area: string;
    location: string;
    time: string;
    ageRange: string;
    schedule: string;
    courseId: number;
  };
  backgroundColor: string;
  borderColor: string;
  textColor: string;
};

const fcEvents: FCEvent[] = [];

for (const course of courses) {
  const colors = AREA_COLORS[course.area] || AREA_COLORS["Artes Visuais"];

  if (course.isRecurring && course.startDate && course.endDate && course.daysOfWeek.length > 0) {
    const start = new Date(course.startDate + "T12:00:00");
    const end = new Date(course.endDate + "T12:00:00");
    const current = new Date(start);
    while (current <= end) {
      if (course.daysOfWeek.includes(current.getDay())) {
        const dateStr = current.toISOString().split("T")[0];
        fcEvents.push({
          id: `${course.id}-${dateStr}`,
          title: course.name,
          start: dateStr,
          extendedProps: {
            area: course.area,
            location: course.location,
            time: `${course.startTime} ‚Äì ${course.endTime}`,
            ageRange: course.ageRange,
            schedule: course.schedule,
            courseId: course.id,
          },
          backgroundColor: colors.bg,
          borderColor: colors.dot,
          textColor: colors.text,
        });
      }
      current.setDate(current.getDate() + 1);
    }
  }

  for (const dateStr of course.specificDates) {
    fcEvents.push({
      id: `${course.id}-${dateStr}`,
      title: course.name,
      start: dateStr,
      extendedProps: {
        area: course.area,
        location: course.location,
        time: `${course.startTime} ‚Äì ${course.endTime}`,
        ageRange: course.ageRange,
        schedule: course.schedule,
        courseId: course.id,
      },
      backgroundColor: colors.bg,
      borderColor: colors.dot,
      textColor: colors.text,
    });
  }
}

const eventsJSON = JSON.stringify(fcEvents);
const areaColorsJSON = JSON.stringify(AREA_COLORS);
const areaIconsJSON = JSON.stringify(AREA_ICONS);
---

<div class="agenda-layout">
  <!-- Calendar side -->
  <div class="agenda-calendar">
    <div id="fullcalendar"></div>
  </div>

  <!-- Day listing side -->
  <div class="agenda-listing" id="agenda-listing">
    <div class="listing-header">
      <h3 class="listing-date" id="listing-date">Selecione um dia</h3>
      <span class="listing-count" id="listing-count"></span>
    </div>
    <div class="listing-placeholder" id="listing-placeholder">
      <div class="listing-placeholder-icon">üìÖ</div>
      <p>Clique em um dia no calend√°rio para ver os cursos desse dia</p>
    </div>
    <div class="listing-items" id="listing-items"></div>
  </div>
</div>

<script define:vars={{ eventsJSON, areaColorsJSON, areaIconsJSON }}>
  // Data is injected server-side
  window.__FC_EVENTS__ = eventsJSON;
  window.__AREA_COLORS__ = areaColorsJSON;
  window.__AREA_ICONS__ = areaIconsJSON;
</script>

<script>
  import { Calendar } from '@fullcalendar/core';
  import dayGridPlugin from '@fullcalendar/daygrid';
  import listPlugin from '@fullcalendar/list';
  import interactionPlugin from '@fullcalendar/interaction';

  const events = JSON.parse((window as any).__FC_EVENTS__);
  const areaColors = JSON.parse((window as any).__AREA_COLORS__);
  const areaIcons = JSON.parse((window as any).__AREA_ICONS__);

  const calendarEl = document.getElementById('fullcalendar')!;
  const listingDate = document.getElementById('listing-date')!;
  const listingCount = document.getElementById('listing-count')!;
  const listingPlaceholder = document.getElementById('listing-placeholder')!;
  const listingItems = document.getElementById('listing-items')!;

  function showDayEvents(dateStr: string) {
    const dayEvents = events.filter((e: any) => e.start === dateStr);
    const d = new Date(dateStr + 'T12:00:00');
    const formatted = d.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
    listingDate.textContent = formatted.charAt(0).toUpperCase() + formatted.slice(1);
    listingCount.textContent = dayEvents.length > 0 ? `${dayEvents.length} curso${dayEvents.length > 1 ? 's' : ''}` : '';

    if (dayEvents.length === 0) {
      listingPlaceholder.style.display = '';
      listingPlaceholder.querySelector('p')!.textContent = 'Nenhum curso neste dia';
      listingItems.innerHTML = '';
      return;
    }

    listingPlaceholder.style.display = 'none';

    // Sort by area then time
    dayEvents.sort((a: any, b: any) => {
      const areaCompare = a.extendedProps.area.localeCompare(b.extendedProps.area);
      if (areaCompare !== 0) return areaCompare;
      return a.extendedProps.time.localeCompare(b.extendedProps.time);
    });

    listingItems.innerHTML = dayEvents.map((e: any) => {
      const c = areaColors[e.extendedProps.area] || areaColors['Artes Visuais'];
      const icon = areaIcons[e.extendedProps.area] || '‚ú®';
      return `
        <div class="listing-event" style="border-left: 3px solid ${c.dot}">
          <div class="listing-event-top">
            <span class="listing-event-badge" style="background:${c.bg};color:${c.text}">${icon} ${e.extendedProps.area}</span>
            <span class="listing-event-time">${e.extendedProps.time}</span>
          </div>
          <div class="listing-event-name">${e.title}</div>
          <div class="listing-event-meta">
            <span class="listing-event-location">üìç ${e.extendedProps.location}</span>
            <span class="listing-event-age">üë§ ${e.extendedProps.ageRange}</span>
          </div>
        </div>
      `;
    }).join('');

    // Scroll listing into view on mobile
    if (window.innerWidth < 768) {
      listingItems.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  const calendar = new Calendar(calendarEl, {
    plugins: [dayGridPlugin, listPlugin, interactionPlugin],
    initialView: 'dayGridMonth',
    initialDate: '2026-03-01',
    locale: 'pt-br',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,listWeek',
    },
    buttonText: {
      today: 'Hoje',
      month: 'M√™s',
      list: 'Lista',
    },
    validRange: {
      start: '2026-02-01',
      end: '2026-08-01',
    },
    events: events,
    height: 'auto',
    dayMaxEventRows: 3,
    moreLinkText: (n: number) => `+${n} mais`,
    eventDisplay: 'block',
    dateClick: function(info: any) {
      showDayEvents(info.dateStr);
      // Highlight selected day
      document.querySelectorAll('.fc-day-selected').forEach(el => el.classList.remove('fc-day-selected'));
      const dayEl = info.dayEl;
      if (dayEl) dayEl.classList.add('fc-day-selected');
    },
    eventClick: function(info: any) {
      info.jsEvent.preventDefault();
      showDayEvents(info.event.startStr);
      // Highlight
      document.querySelectorAll('.fc-day-selected').forEach(el => el.classList.remove('fc-day-selected'));
      const dateStr = info.event.startStr;
      const dayCell = calendarEl.querySelector(`[data-date="${dateStr}"]`);
      if (dayCell) dayCell.classList.add('fc-day-selected');
    },
    eventDidMount: function(info: any) {
      const props = info.event.extendedProps;
      info.el.title = `${props.area} ‚Äî ${info.event.title}\n${props.time} ¬∑ ${props.location}`;
    },
  });

  calendar.render();
</script>

<style is:global>
  /* FullCalendar theme overrides */
  .fc {
    --fc-border-color: var(--border);
    --fc-button-bg-color: white;
    --fc-button-border-color: var(--border);
    --fc-button-text-color: var(--text-secondary);
    --fc-button-hover-bg-color: var(--accent-light);
    --fc-button-hover-border-color: var(--accent);
    --fc-button-active-bg-color: var(--accent);
    --fc-button-active-border-color: var(--accent);
    --fc-button-active-text-color: white;
    --fc-today-bg-color: rgba(45, 90, 39, 0.06);
    --fc-page-bg-color: transparent;
    --fc-neutral-bg-color: var(--bg-elevated);
    --fc-event-border-color: transparent;
    font-family: var(--font-sans) !important;
    font-size: 0.85rem;
  }

  .fc .fc-toolbar-title {
    font-family: var(--font-display) !important;
    font-size: 1.25rem !important;
    font-weight: 400;
  }

  .fc .fc-button {
    font-family: var(--font-sans) !important;
    font-size: 0.8rem !important;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: var(--radius-sm) !important;
    transition: all 150ms ease;
    box-shadow: none !important;
    text-transform: none;
  }

  .fc .fc-button:focus {
    box-shadow: 0 0 0 2px var(--accent) !important;
  }

  .fc .fc-col-header-cell {
    padding: 8px 0;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-muted);
  }

  .fc .fc-col-header-cell-cushion {
    color: var(--text-muted);
    text-decoration: none !important;
  }

  .fc .fc-daygrid-day-number {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
    padding: 4px 8px;
    text-decoration: none !important;
  }

  .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number {
    color: var(--accent);
    font-weight: 700;
  }

  .fc .fc-daygrid-day {
    cursor: pointer;
    transition: background 150ms ease;
    min-height: 80px;
  }

  .fc .fc-daygrid-day:hover {
    background: var(--accent-light) !important;
  }

  .fc .fc-daygrid-day.fc-day-selected {
    background: rgba(45, 90, 39, 0.1) !important;
    outline: 2px solid var(--accent);
    outline-offset: -2px;
    border-radius: 4px;
  }

  .fc .fc-daygrid-event {
    border-radius: 4px !important;
    padding: 1px 4px;
    font-size: 0.7rem !important;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: 1px;
    cursor: pointer;
    border-left-width: 3px !important;
    border-left-style: solid !important;
  }

  .fc .fc-daygrid-event .fc-event-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .fc .fc-more-link {
    font-size: 0.7rem !important;
    font-weight: 600;
    color: var(--accent) !important;
  }

  /* List view */
  .fc .fc-list-event-title a {
    color: var(--text-primary) !important;
    font-weight: 600;
    text-decoration: none !important;
  }

  .fc .fc-list-day-cushion {
    background: var(--bg-elevated) !important;
    font-weight: 600;
  }

  .fc .fc-list-event-dot {
    border-radius: 50%;
  }

  .fc .fc-list-event:hover td {
    background: var(--accent-light) !important;
  }

  /* Mobile toolbar */
  @media (max-width: 640px) {
    .fc .fc-toolbar {
      flex-direction: column;
      gap: 8px;
    }

    .fc .fc-toolbar-chunk {
      display: flex;
      justify-content: center;
    }

    .fc .fc-toolbar-title {
      font-size: 1.1rem !important;
    }

    .fc .fc-daygrid-day {
      min-height: 60px;
    }

    .fc .fc-daygrid-event {
      font-size: 0.6rem !important;
      padding: 0 2px;
    }
  }
</style>

<style>
  .agenda-layout {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .agenda-calendar {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    overflow: hidden;
    min-width: 0;
  }

  .agenda-listing {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    display: flex;
    flex-direction: column;
    min-height: 300px;
  }

  .listing-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border);
  }

  .listing-date {
    font-family: var(--font-sans);
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-primary);
  }

  .listing-count {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--accent);
    background: var(--accent-light);
    padding: 2px 10px;
    border-radius: var(--radius-full);
  }

  .listing-placeholder {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text-muted);
    gap: var(--space-sm);
    padding: var(--space-xl);
  }

  .listing-placeholder-icon {
    font-size: 2.5rem;
    opacity: 0.4;
  }

  .listing-placeholder p {
    font-size: 0.875rem;
    max-width: 240px;
  }

  .listing-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    overflow-y: auto;
    max-height: 500px;
  }

  @media (min-width: 768px) {
    .agenda-layout {
      flex-direction: row;
      align-items: flex-start;
    }

    .agenda-calendar {
      flex: 3;
      padding: var(--space-lg);
    }

    .agenda-listing {
      flex: 2;
      position: sticky;
      top: calc(var(--header-height) + 1rem);
      max-height: calc(100vh - var(--header-height) - 2rem);
      padding: var(--space-lg);
    }

    .listing-items {
      max-height: none;
      overflow-y: auto;
      flex: 1;
    }
  }

  @media (min-width: 1024px) {
    .agenda-calendar {
      flex: 2;
    }

    .agenda-listing {
      flex: 1;
    }
  }
</style>

<style is:global>
  /* Listing event items (injected via JS) */
  .listing-event {
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
    transition: all 150ms ease;
  }

  .listing-event:hover {
    background: var(--bg-card);
    box-shadow: var(--shadow-sm);
  }

  .listing-event-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-sm);
    margin-bottom: 4px;
  }

  .listing-event-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 0.65rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .listing-event-time {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .listing-event-name {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-primary);
    line-height: 1.3;
    margin-bottom: 4px;
  }

  .listing-event-meta {
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-size: 0.725rem;
    color: var(--text-muted);
  }
</style>
